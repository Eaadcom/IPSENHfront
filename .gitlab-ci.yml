image: trion/ng-cli:11.2.6
stages:
  - preparation
  - testing
  - building
  - deploying

npm:
  stage: preparation
  script:
    - npm -v
    - npm ci
  cache:
    paths:
      - node_modules/

unit_test:
  stage: testing
  dependencies:
    - npm
  image: efgiese/efgiese-angular-chrome-headless
  cache:
    key: $CI_COMMIT_REF_SLUG-$CI_PROJECT_DIR
    paths:
      - node_modules/
    policy: pull
  script:
    - npm run test-headless

lint:
  stage: testing
  dependencies:
    - npm
  cache:
    key: $CI_COMMIT_REF_SLUG-$CI_PROJECT_DIR
    paths:
      - node_modules/
    policy: pull
  script:
    - ng lint ipsenh-frontend

build:
  stage: building
  dependencies:
    - unit_test
    - lint
  cache:
    key: $CI_COMMIT_REF_SLUG-$CI_PROJECT_DIR
    paths:
      - node_modules/
    policy: pull
  script:
    - ng build --prod
  artifacts:
    paths:
      - dist/
    expire_in: 1 days
    when: always

deploy:
  stage: deploying
  dependencies:
    - build
  script:
    - echo "deploy hoi"

